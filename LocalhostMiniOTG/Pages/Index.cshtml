@page
@model IndexModel
@{
    ViewData["Title"] = "Media Player";
}

<!-- Folder Picker Modal -->
<div class="modal fade" id="folderModal" tabindex="-1">
<div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content" style="background:#1a1a2e; max-height:90vh;">
        <div class="modal-header border-secondary">
            <h5 class="modal-title text-light"><i class="bi bi-folder2-open me-2"></i>Choose Media Folder</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" style="overflow-y:auto; -webkit-overflow-scrolling:touch;">
            <div id="currentBrowsePath" class="text-info small mb-2 text-break" style="font-family:monospace;"></div>
            <div id="driveList" class="mb-3"></div>
            <div id="folderList"></div>
        </div>
            <div class="modal-footer border-secondary">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button class="btn btn-primary" id="btnSelectFolder" disabled>
                    <i class="bi bi-check-lg me-1"></i>Use This Folder
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Settings Bar -->
<div class="settings-bar d-flex align-items-center gap-2 mb-4 p-2 rounded" style="background:#1a1a2e;">
    <i class="bi bi-folder-fill text-warning"></i>
    <code class="text-info flex-grow-1 text-truncate" title="@Model.MediaRoot">@Model.MediaRoot</code>
    <button class="btn btn-sm btn-outline-light" data-bs-toggle="modal" data-bs-target="#folderModal">
        <i class="bi bi-folder2-open me-1"></i>Change Folder
    </button>
</div>


@if (!string.IsNullOrEmpty(Model.NowPlaying))
{
    <div class="player-section mb-4">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h4 class="text-light mb-0">
                <i class="bi bi-play-circle-fill me-2"></i>@Model.NowPlayingName
            </h4>
            <div class="d-flex align-items-center gap-2">
                @if (Model.NowPlayingUseHls)
                {
                    <div class="btn-group btn-group-sm" role="group" id="qualityBtns">
                        <button class="btn btn-outline-secondary" data-q="low" title="480p ~1 Mbps - slow WiFi">
                            <i class="bi bi-wifi-1 me-1"></i>Low
                        </button>
                        <button class="btn btn-outline-secondary" data-q="medium" title="720p ~2.5 Mbps">
                            <i class="bi bi-wifi-2 me-1"></i>Med
                        </button>
                        <button class="btn btn-outline-secondary" data-q="high" title="Original quality">
                            <i class="bi bi-wifi me-1"></i>High
                        </button>
                    </div>
                }
                <a href="/api/download?file=@Uri.EscapeDataString(Model.NowPlaying)" class="btn btn-sm btn-outline-info" title="Download original file">
                    <i class="bi bi-download"></i>
                </a>
                <a asp-page="/Index" asp-route-folder="@Model.CurrentFolder" class="btn btn-sm btn-outline-light">&times; Close</a>
            </div>
        </div>

        @if (Model.NowPlayingUseHls)
        {
            <!-- HLS: loading spinner, removed once video plays -->
            <div id="hlsLoading" style="min-height:260px; background:#000; display:flex; flex-direction:column; align-items:center; justify-content:center; border-radius:8px;">
                <div class="spinner-border text-info mb-3" role="status"></div>
                <p class="text-light small mb-0">Preparing stream…</p>
            </div>
            <!-- HLS: video player, hidden until ready -->
            <div id="hlsPlayerWrap" class="video-wrapper" style="display:none;">
                <video id="videoPlayer" controls autoplay playsinline webkit-playsinline></video>
            </div>
        }
        else
        {
            <div class="video-wrapper">
                <video id="videoPlayer" controls autoplay playsinline webkit-playsinline preload="auto">
                    <source src="/api/stream?file=@Uri.EscapeDataString(Model.NowPlaying)" type="@Model.NowPlayingType" />
                </video>
            </div>
        }
    </div>
}

<!-- Photo Viewer -->
@if (!string.IsNullOrEmpty(Model.ViewingPhoto))
{
    <div class="player-section mb-4">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h4 class="text-light mb-0">
                <i class="bi bi-image me-2"></i>@Model.ViewingPhotoName
            </h4>
            <div>
                @if (Model.ViewingPhotoIndex > 0)
                {
                    <a asp-page="/Index" asp-route-folder="@Model.CurrentFolder" asp-route-photo="@Model.Photos[Model.ViewingPhotoIndex - 1].RelativePath" class="btn btn-sm btn-outline-light me-1"><i class="bi bi-chevron-left"></i></a>
                }
                @if (Model.ViewingPhotoIndex >= 0 && Model.ViewingPhotoIndex < Model.Photos.Count - 1)
                {
                    <a asp-page="/Index" asp-route-folder="@Model.CurrentFolder" asp-route-photo="@Model.Photos[Model.ViewingPhotoIndex + 1].RelativePath" class="btn btn-sm btn-outline-light me-1"><i class="bi bi-chevron-right"></i></a>
                }
                <a href="/api/download?file=@Uri.EscapeDataString(Model.ViewingPhoto!)" class="btn btn-sm btn-outline-info" title="Download original file">
                    <i class="bi bi-download"></i>
                </a>
                <a asp-page="/Index" asp-route-folder="@Model.CurrentFolder" class="btn btn-sm btn-outline-light">&times; Close</a>
            </div>
        </div>
        <div class="text-center rounded" style="background:#000; padding:8px; position:relative; cursor:pointer;" id="photoViewerArea">
            @{
                var photoExt = System.IO.Path.GetExtension(Model.ViewingPhoto!).ToLowerInvariant();
                var isRaw = photoExt is ".cr2" or ".nef" or ".arw" or ".dng";
                var photoSrc = isRaw
                    ? $"/api/photo?file={Uri.EscapeDataString(Model.ViewingPhoto!)}"
                    : $"/api/stream?file={Uri.EscapeDataString(Model.ViewingPhoto!)}";
            }
            <img src="@photoSrc" alt="@Model.ViewingPhotoName"
                 style="max-width:100%; max-height:75vh; object-fit:contain; border-radius:4px;" />
            <!-- Left/Right click zones -->
            @if (Model.ViewingPhotoIndex > 0)
            {
                <a asp-page="/Index" asp-route-folder="@Model.CurrentFolder" asp-route-photo="@Model.Photos[Model.ViewingPhotoIndex - 1].RelativePath"
                   class="photo-nav-zone photo-nav-left" title="Previous">
                    <i class="bi bi-chevron-left"></i>
                </a>
            }
            @if (Model.ViewingPhotoIndex >= 0 && Model.ViewingPhotoIndex < Model.Photos.Count - 1)
            {
                <a asp-page="/Index" asp-route-folder="@Model.CurrentFolder" asp-route-photo="@Model.Photos[Model.ViewingPhotoIndex + 1].RelativePath"
                   class="photo-nav-zone photo-nav-right" title="Next">
                    <i class="bi bi-chevron-right"></i>
                </a>
            }
        </div>
        @if (Model.Photos.Count > 1)
        {
            <div class="text-center text-secondary small mt-1">@(Model.ViewingPhotoIndex + 1) / @Model.Photos.Count</div>
        }
    </div>
}

<!-- Audio Player -->
@if (!string.IsNullOrEmpty(Model.PlayingAudio))
{
    <div class="player-section mb-4">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h4 class="text-light mb-0">
                <i class="bi bi-music-note-beamed me-2"></i>@Model.PlayingAudioName
            </h4>
            <div class="d-flex align-items-center gap-2">
                <a href="/api/download?file=@Uri.EscapeDataString(Model.PlayingAudio)" class="btn btn-sm btn-outline-info" title="Download original file">
                    <i class="bi bi-download"></i>
                </a>
                <a asp-page="/Index" asp-route-folder="@Model.CurrentFolder" class="btn btn-sm btn-outline-light">&times; Close</a>
            </div>
        </div>
        <div class="p-3 rounded" style="background:#1a1a2e;">
            <audio id="audioPlayer" controls autoplay style="width:100%;">
                <source src="/api/stream?file=@Uri.EscapeDataString(Model.PlayingAudio)" type="@Model.PlayingAudioType" />
            </audio>
        </div>
    </div>
}

<!-- Breadcrumb Navigation -->
@if (!string.IsNullOrEmpty(Model.CurrentFolder))
{
    <nav class="mb-3">
        <ol class="breadcrumb" style="--bs-breadcrumb-divider:'›';">
            <li class="breadcrumb-item"><a asp-page="/Index" class="text-info">🏠 Root</a></li>
            @{
                var parts = Model.CurrentFolder.Split('/', StringSplitOptions.RemoveEmptyEntries);
                for (int i = 0; i < parts.Length; i++)
                {
                    var partial = string.Join("/", parts.Take(i + 1));
                    if (i == parts.Length - 1)
                    {
                        <li class="breadcrumb-item active text-light">@parts[i]</li>
                    }
                    else
                    {
                        <li class="breadcrumb-item"><a asp-page="/Index" asp-route-folder="@partial" class="text-info">@parts[i]</a></li>
                    }
                }
            }
        </ol>
    </nav>
}

<!-- Subfolders -->
@if (Model.Subfolders.Count > 0)
{
    <div class="mb-4">
        <h5 class="text-light mb-2"><i class="bi bi-folder me-2"></i>Folders</h5>
        <div class="row row-cols-2 row-cols-sm-3 row-cols-md-4 row-cols-lg-6 g-2">
            @foreach (var folder in Model.Subfolders)
            {
                <div class="col">
                    <a asp-page="/Index" asp-route-folder="@folder.RelativePath" class="text-decoration-none" tabindex="0">
                        <div class="folder-card p-2 rounded text-center">
                            <i class="bi bi-folder-fill text-warning" style="font-size:2rem;"></i>
                            <div class="text-truncate text-light small mt-1" title="@folder.Name">@folder.Name</div>
                        </div>
                    </a>
                </div>
            }
        </div>
    </div>
}

<!-- Video Library -->
<div class="library-section">
    @if (Model.Videos.Count > 0 || Model.Photos.Count > 0)
    {
        <!-- View toggle + Slideshow buttons -->
        <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
            <div class="btn-group btn-group-sm" role="group">
                <button class="btn btn-outline-light active" id="btnViewSeparate" title="Separate lists">
                    <i class="bi bi-list-ul me-1"></i>Separate
                </button>
                <button class="btn btn-outline-light" id="btnViewCombined" title="Combined photo + video grid">
                    <i class="bi bi-grid-3x3-gap me-1"></i>Combined
                </button>
            </div>
            @if (Model.AllMedia.Count > 1)
            {
                <button class="btn btn-sm btn-outline-info" id="btnSlideshow">
                    <i class="bi bi-play-circle me-1"></i>Slideshow
                </button>
            }
        </div>
    }

    <!-- === SEPARATE VIEW (default) === -->
    <div id="viewSeparate">
    @if (Model.Videos.Count > 0)
    {
        <h5 class="text-light mb-3"><i class="bi bi-collection-play me-2"></i>Videos (@Model.Videos.Count)</h5>
        <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-3 mb-4">
            @foreach (var video in Model.Videos)
            {
                <div class="col">
                    <a asp-page="/Index" asp-route-folder="@Model.CurrentFolder" asp-route-play="@video.RelativePath" class="text-decoration-none" tabindex="0">
                        <div class="card movie-card h-100 @(Model.NowPlaying == video.RelativePath ? "border-primary" : "")">
                            <div class="card-thumb d-flex align-items-center justify-content-center">
                                <span class="play-icon">&#9654;</span>
                            </div>
                            <div class="card-body p-2">
                                <h6 class="card-title text-truncate mb-1" title="@video.DisplayName">@video.DisplayName</h6>
                                <small class="text-secondary">@video.FormattedSize &middot; @System.IO.Path.GetExtension(video.FileName).TrimStart('.').ToUpper()</small>
                            </div>
                        </div>
                    </a>
                </div>
            }
        </div>
    }

    @if (Model.Photos.Count > 0)
    {
        <h5 class="text-light mb-3"><i class="bi bi-images me-2"></i>Photos (@Model.Photos.Count)</h5>
        <div class="row row-cols-2 row-cols-sm-3 row-cols-md-4 row-cols-lg-6 g-2 mb-4">
            @foreach (var photo in Model.Photos)
            {
                <div class="col">
                    <a asp-page="/Index" asp-route-folder="@Model.CurrentFolder" asp-route-photo="@photo.RelativePath" class="text-decoration-none" tabindex="0">
                        <div class="card movie-card h-100 @(Model.ViewingPhoto == photo.RelativePath ? "border-primary" : "")">
                            <div style="height:100px; overflow:hidden; background:#16213e; border-radius:8px 8px 0 0;">
                                <img src="/api/photo/thumb?file=@Uri.EscapeDataString(photo.RelativePath)"
                                     alt="@photo.DisplayName" loading="lazy"
                                     style="width:100%; height:100%; object-fit:cover;" />
                            </div>
                            <div class="card-body p-2">
                                <h6 class="card-title text-truncate mb-1" style="font-size:0.75rem;" title="@photo.DisplayName">@photo.DisplayName</h6>
                                <small class="text-secondary" style="font-size:0.7rem;">@photo.FormattedSize &middot; @System.IO.Path.GetExtension(photo.FileName).TrimStart('.').ToUpper()</small>
                            </div>
                        </div>
                    </a>
                </div>
            }
        </div>
    }

    @if (Model.Audios.Count > 0)
    {
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="text-light mb-0"><i class="bi bi-music-note-list me-2"></i>Audio (@Model.Audios.Count)</h5>
            <a asp-page="/Music" asp-route-folder="@Model.CurrentFolder" class="btn btn-sm btn-outline-info" target="_blank">
                <i class="bi bi-box-arrow-up-right me-1"></i>Open Music Player
            </a>
        </div>
        <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-2 mb-4">
            @foreach (var audio in Model.Audios)
            {
                <div class="col">
                    <a asp-page="/Index" asp-route-folder="@Model.CurrentFolder" asp-route-audio="@audio.RelativePath" class="text-decoration-none" tabindex="0">
                        <div class="card movie-card h-100 @(Model.PlayingAudio == audio.RelativePath ? "border-primary" : "")">
                            <div class="d-flex align-items-center p-2">
                                <i class="bi bi-music-note-beamed text-info me-2" style="font-size:1.5rem;"></i>
                                <div class="flex-grow-1 overflow-hidden">
                                    <h6 class="card-title text-truncate mb-0" style="font-size:0.85rem;" title="@audio.DisplayName">@audio.DisplayName</h6>
                                    <small class="text-secondary">@audio.FormattedSize &middot; @System.IO.Path.GetExtension(audio.FileName).TrimStart('.').ToUpper()</small>
                                </div>
                            </div>
                        </div>
                    </a>
                </div>
            }
        </div>
    }
    </div><!-- end viewSeparate -->

    <!-- === COMBINED VIEW (photos + videos mixed) === -->
    <div id="viewCombined" style="display:none;">
        @if (Model.AllMedia.Count > 0)
        {
            <h5 class="text-light mb-3"><i class="bi bi-grid-3x3-gap me-2"></i>All Media (@Model.AllMedia.Count)</h5>
            <div class="row row-cols-2 row-cols-sm-3 row-cols-md-4 row-cols-lg-6 g-2 mb-4">
                @for (int i = 0; i < Model.AllMedia.Count; i++)
                {
                    var m = Model.AllMedia[i];
                    var ext = System.IO.Path.GetExtension(m.FileName).TrimStart('.').ToUpper();
                    if (m.Type == "photo")
                    {
                        <div class="col">
                            <a asp-page="/Index" asp-route-folder="@Model.CurrentFolder" asp-route-photo="@m.RelativePath" class="text-decoration-none" tabindex="0">
                                <div class="card movie-card h-100">
                                    <div style="height:100px; overflow:hidden; background:#16213e; border-radius:8px 8px 0 0; position:relative;">
                                        <img src="/api/photo/thumb?file=@Uri.EscapeDataString(m.RelativePath)"
                                             alt="@m.DisplayName" loading="lazy"
                                             style="width:100%; height:100%; object-fit:cover;" />
                                        <span class="badge bg-success" style="position:absolute; top:4px; right:4px; font-size:0.6rem;">PHOTO</span>
                                    </div>
                                    <div class="card-body p-2">
                                        <h6 class="card-title text-truncate mb-0" style="font-size:0.75rem;" title="@m.DisplayName">@m.DisplayName</h6>
                                    </div>
                                </div>
                            </a>
                        </div>
                    }
                    else
                    {
                        <div class="col">
                            <a asp-page="/Index" asp-route-folder="@Model.CurrentFolder" asp-route-play="@m.RelativePath" class="text-decoration-none" tabindex="0">
                                <div class="card movie-card h-100">
                                    <div class="d-flex align-items-center justify-content-center" style="height:100px; background:linear-gradient(135deg,#16213e,#0f3460); border-radius:8px 8px 0 0; position:relative;">
                                        <span style="font-size:2rem; color:rgba(255,255,255,0.3);">&#9654;</span>
                                        <span class="badge bg-primary" style="position:absolute; top:4px; right:4px; font-size:0.6rem;">VIDEO</span>
                                    </div>
                                    <div class="card-body p-2">
                                        <h6 class="card-title text-truncate mb-0" style="font-size:0.75rem;" title="@m.DisplayName">@m.DisplayName</h6>
                                    </div>
                                </div>
                            </a>
                        </div>
                    }
                }
            </div>
        }
    </div><!-- end viewCombined -->

    <!-- === SLIDESHOW OVERLAY === -->
    <div id="slideshowOverlay" style="display:none; position:fixed; inset:0; z-index:9999; background:#000;">
        <div id="slideshowContent" style="width:100%; height:100%; display:flex; align-items:center; justify-content:center;">
            <img id="ssImage" style="max-width:100%; max-height:100%; object-fit:contain; display:none;" />
            <video id="ssVideo" controls autoplay playsinline webkit-playsinline style="max-width:100%; max-height:100%; display:none;"></video>
        </div>
        <!-- Left/Right click zones for prev/next -->
        <div id="ssNavLeft" class="ss-nav-zone ss-nav-left"><i class="bi bi-chevron-left"></i></div>
        <div id="ssNavRight" class="ss-nav-zone ss-nav-right"><i class="bi bi-chevron-right"></i></div>
        <!-- Slideshow controls -->
        <div style="position:absolute; bottom:0; left:0; right:0; padding:12px; background:linear-gradient(transparent, rgba(0,0,0,0.8)); display:flex; align-items:center; justify-content:center; gap:8px;">
            <button class="btn btn-sm btn-outline-light" id="ssPrev"><i class="bi bi-skip-start-fill"></i></button>
            <button class="btn btn-sm btn-outline-light" id="ssPlayPause"><i class="bi bi-pause-fill" id="ssPlayIcon"></i></button>
            <button class="btn btn-sm btn-outline-light" id="ssNext"><i class="bi bi-skip-end-fill"></i></button>
            <span class="text-light small ms-2" id="ssCounter">1 / 1</span>
            <span class="text-secondary small ms-2 text-truncate" id="ssTitle" style="max-width:40%;"></span>
            <div class="ms-auto d-flex align-items-center gap-2">
                <select class="form-select form-select-sm" id="ssSpeed" style="width:auto; background:#222; color:#fff; border-color:#555;">
                    <option value="3">3s</option>
                    <option value="5" selected>5s</option>
                    <option value="8">8s</option>
                    <option value="15">15s</option>
                </select>
                <a class="btn btn-sm btn-outline-info" id="ssDownload" href="#" title="Download"><i class="bi bi-download"></i></a>
                <button class="btn btn-sm btn-outline-danger" id="ssClose"><i class="bi bi-x-lg"></i></button>
            </div>
        </div>
        <!-- Progress bar -->
        <div style="position:absolute; top:0; left:0; right:0; height:3px; background:rgba(255,255,255,0.1);">
            <div id="ssProgress" style="height:100%; background:#0dcaf0; width:0%; transition:width 0.3s linear;"></div>
        </div>
    </div>

    @if (Model.Videos.Count == 0 && Model.Photos.Count == 0 && Model.Audios.Count == 0 && Model.Subfolders.Count == 0)
    {
        <div class="empty-state text-center py-5">
            <div class="display-1 text-secondary mb-3">🎬</div>
            <h5 class="text-light">No media here</h5>
            <p class="text-secondary">
                Click <strong>Change Folder</strong> above to point to a folder with media files.
            </p>
            <p class="text-secondary small">
                Video: mp4, mkv, avi, mov, wmv &middot;
                Photo: jpg, png, gif, cr2, nef, dng &middot;
                Audio: mp3, flac, wma, aac, ogg, wav
            </p>
        </div>
    }
</div>

@section Scripts {
<script>
    let currentBrowsePath = '';

    document.getElementById('folderModal').addEventListener('show.bs.modal', function () {
        loadDrives();
    });

    document.getElementById('btnSelectFolder').addEventListener('click', async function () {
        if (!currentBrowsePath) return;
        const res = await fetch('/api/settings/media-root', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ path: currentBrowsePath })
        });
        if (res.ok) {
            window.location.href = '/?folder=';
        }
    });

    async function loadDrives() {
        currentBrowsePath = '';
        updateBrowseUI();
        const res = await fetch('/api/browse/drives');
        const drives = await res.json();
        const driveHtml = drives.map(d =>
            `<button class="btn btn-outline-info btn-sm me-2 mb-2" onclick="browseFolder('${escapeJs(d.name)}')">
                <i class="bi bi-hdd me-1"></i>${d.label} <small class="text-secondary">(${d.freeGB} GB free)</small>
            </button>`
        ).join('');
        document.getElementById('driveList').innerHTML = driveHtml;
        document.getElementById('folderList').innerHTML = '<p class="text-secondary">Select a drive above</p>';
    }

    async function browseFolder(path) {
        currentBrowsePath = path;
        updateBrowseUI();
        const res = await fetch(`/api/browse/folder?path=${encodeURIComponent(path)}`);
        if (!res.ok) { document.getElementById('folderList').innerHTML = '<p class="text-danger">Cannot access this folder</p>'; return; }
        const entries = await res.json();
        if (entries.length === 0) {
            document.getElementById('folderList').innerHTML = '<p class="text-secondary">Empty folder</p>';
            return;
        }
        const html = entries.map(e => {
            const icon = e.name === '..' ? 'bi-arrow-up-circle' : 'bi-folder-fill';
            const color = e.name === '..' ? 'text-secondary' : 'text-warning';
            const badge = e.videoCount > 0 ? `<span class="badge bg-success ms-2">${e.videoCount} vid</span>` : '';
            const pbadge = e.photoCount > 0 ? `<span class="badge bg-info ms-1">${e.photoCount} img</span>` : '';
            const abadge = e.audioCount > 0 ? `<span class="badge bg-warning text-dark ms-1">${e.audioCount} audio</span>` : '';
            return `<div class="browse-entry d-flex align-items-center p-2 rounded mb-1" style="cursor:pointer;" onclick="browseFolder('${escapeJs(e.fullPath)}')">
                <i class="bi ${icon} ${color} me-2"></i>
                <span class="text-light flex-grow-1">${escapeHtml(e.name)}</span>${badge}${pbadge}${abadge}
            </div>`;
        }).join('');
        document.getElementById('folderList').innerHTML = html;
    }

    function updateBrowseUI() {
        document.getElementById('currentBrowsePath').textContent = currentBrowsePath || '(select a drive)';
        document.getElementById('btnSelectFolder').disabled = !currentBrowsePath;
    }

    function escapeJs(s) { return s.replace(/\\/g, '/').replace(/'/g, "\\'"); }
    function escapeHtml(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

    @if (Model.NowPlayingUseHls && !string.IsNullOrEmpty(Model.NowPlaying))
    {
        <text>
    (async function() {
        const file = '@Html.Raw(Model.NowPlaying?.Replace("\\", "\\\\").Replace("'", "\\'"))';
        let currentQuality = 'auto';
        let sid = null;
        let playlistUrl = null;
        let hlsInstance = null;
        let sessionVersion = 0; // incremented on each switch to cancel stale polls
        let switching = false;  // debounce rapid clicks

        // --- Auto-detect bandwidth by downloading 100KB test payload ---
        async function detectSpeed() {
            try {
                const url = '/api/speedtest?_t=' + Date.now();
                const t0 = performance.now();
                const r = await fetch(url);
                const buf = await r.arrayBuffer();
                const ms = performance.now() - t0;
                const seconds = ms / 1000;
                const bits = buf.byteLength * 8;
                const mbps = bits / seconds / 1_000_000;
                console.log('[AutoQuality] ' + (buf.byteLength/1024).toFixed(0) + ' KB in ' + ms.toFixed(0) + 'ms = ' + mbps.toFixed(1) + ' Mbps');
                // 100KB test: Low needs ~0.6 Mbps, Med needs ~1.7 Mbps
                if (2 >= mbps) return 'low';
                if (8 >= mbps) return 'medium';
                return 'high';
            } catch {
                return 'medium';
            }
        }

        // --- Start HLS session with given quality ---
        async function startSession(quality) {
            if (switching) return;
            switching = true;

            currentQuality = quality;
            sessionVersion++;
            const myVersion = sessionVersion;
            highlightQualityBtn(quality);

            // Destroy old player immediately
            if (hlsInstance) { hlsInstance.destroy(); hlsInstance = null; }
            const videoEl = document.getElementById('videoPlayer');
            if (videoEl) { videoEl.pause(); videoEl.removeAttribute('src'); videoEl.load(); }

            // Show loading
            const loading = document.getElementById('hlsLoading');
            const wrap = document.getElementById('hlsPlayerWrap');
            if (loading) {
                loading.style.display = 'flex';
                loading.innerHTML =
                    '<div class="spinner-border text-info mb-3" role="status"></div>' +
                    '<p class="text-light small mb-0">Preparing stream (' + quality + ')...</p>';
            }
            if (wrap) wrap.style.display = 'none';

            try {
                const startRes = await fetch('/api/hls/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ file: file, quality: quality })
                });
                if (myVersion !== sessionVersion) { switching = false; return; } // stale

                const startData = await startRes.json();
                sid = startData.sessionId;
                playlistUrl = '/api/hls/' + encodeURIComponent(sid) + '/stream.m3u8';

                pollReady(myVersion);
            } catch (e) {
                if (loading) loading.innerHTML = '<p class="text-danger small">Failed to start stream</p>';
            }
            switching = false;
        }

        // --- Poll until first segment is ready ---
        async function pollReady(myVersion) {
            if (myVersion !== sessionVersion) return; // cancelled
            try {
                const r = await fetch('/api/hls/status?id=' + encodeURIComponent(sid));
                if (myVersion !== sessionVersion) return;
                const d = await r.json();
                if (d.error) {
                    const loading = document.getElementById('hlsLoading');
                    if (loading) loading.innerHTML = '<p class="text-danger small">Error: ' + d.error + '</p>';
                    return;
                }
                if (d.ready) {
                    startPlayer(myVersion);
                    return;
                }
            } catch { }
            if (myVersion === sessionVersion) setTimeout(() => pollReady(myVersion), 1000);
        }

        // --- Start/restart the video player ---
        function startPlayer(myVersion) {
            if (myVersion !== sessionVersion) return;

            const loading = document.getElementById('hlsLoading');
            if (loading) loading.style.display = 'none';
            const wrap = document.getElementById('hlsPlayerWrap');
            if (wrap) wrap.style.display = 'block';
            const video = document.getElementById('videoPlayer');

            if (video.canPlayType('application/vnd.apple.mpegurl')) {
                video.src = playlistUrl + '?_t=' + Date.now();
                video.play().catch(() => {});
            }
            else if (typeof Hls !== 'undefined' && Hls.isSupported()) {
                hlsInstance = new Hls({
                    maxBufferLength: 30,
                    maxMaxBufferLength: 60,
                    fragLoadingMaxRetry: 20,
                    fragLoadingRetryDelay: 1000,
                    levelLoadingMaxRetry: 20
                });
                hlsInstance.loadSource(playlistUrl + '?_t=' + Date.now());
                hlsInstance.attachMedia(video);
                hlsInstance.on(Hls.Events.MANIFEST_PARSED, () => video.play().catch(() => {}));
            }
            else {
                if (wrap) wrap.innerHTML = '<p class="text-danger p-3">Browser does not support HLS playback.</p>';
            }
        }

        // --- Quality button highlight ---
        function highlightQualityBtn(q) {
            const btns = document.querySelectorAll('#qualityBtns button');
            const colors = { low: 'btn-warning', medium: 'btn-info', high: 'btn-success' };
            btns.forEach(b => {
                const bq = b.dataset.q;
                b.className = 'btn ' + (bq === q ? colors[bq] : 'btn-outline-secondary');
            });
        }

        // --- Quality button click handlers ---
        document.querySelectorAll('#qualityBtns button').forEach(btn => {
            btn.addEventListener('click', () => startSession(btn.dataset.q));
        });

        // --- Stop on page leave ---
        function stopSession() {
            if (sid) navigator.sendBeacon('/api/hls/stop', JSON.stringify({ id: sid }));
        }
        window.addEventListener('beforeunload', stopSession);
        window.addEventListener('pagehide', stopSession);

        // --- Auto-detect and start ---
        const detected = await detectSpeed();
        startSession(detected);
    })();
        </text>
    }

    // === VIEW TOGGLE: Separate / Combined ===
    const btnSep = document.getElementById('btnViewSeparate');
    const btnComb = document.getElementById('btnViewCombined');
    const viewSep = document.getElementById('viewSeparate');
    const viewComb = document.getElementById('viewCombined');
    if (btnSep && btnComb) {
        btnSep.addEventListener('click', () => {
            viewSep.style.display = ''; viewComb.style.display = 'none';
            btnSep.classList.add('active'); btnComb.classList.remove('active');
        });
        btnComb.addEventListener('click', () => {
            viewSep.style.display = 'none'; viewComb.style.display = '';
            btnComb.classList.add('active'); btnSep.classList.remove('active');
        });
    }

    // === SLIDESHOW ===
    @if (Model.AllMedia.Count > 1)
    {
        <text>
    (function() {
        const allMedia = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.AllMedia.Select(m => new {
            type = m.Type,
            path = m.RelativePath,
            name = m.DisplayName,
            file = m.FileName
        })));

        const overlay = document.getElementById('slideshowOverlay');
        const ssImage = document.getElementById('ssImage');
        const ssVideo = document.getElementById('ssVideo');
        const ssCounter = document.getElementById('ssCounter');
        const ssTitle = document.getElementById('ssTitle');
        const ssProgress = document.getElementById('ssProgress');
        const ssDownload = document.getElementById('ssDownload');
        const ssSpeed = document.getElementById('ssSpeed');
        const ssPlayIcon = document.getElementById('ssPlayIcon');

        let ssIdx = 0;
        let ssTimer = null;
        let ssPlaying = true;
        let ssProgressTimer = null;

        function getInterval() { return parseInt(ssSpeed.value) * 1000; }

        function showSlide(idx) {
            ssIdx = ((idx % allMedia.length) + allMedia.length) % allMedia.length;
            const m = allMedia[ssIdx];
            const isPhoto = m.type === 'photo';
            const ext = m.file.split('.').pop().toLowerCase();
            const isRaw = ['cr2','nef','arw','dng'].includes(ext);

            ssImage.style.display = 'none';
            ssVideo.style.display = 'none';
            ssVideo.pause();
            ssVideo.removeAttribute('src');

            if (isPhoto) {
                const src = isRaw
                    ? '/api/photo?file=' + encodeURIComponent(m.path)
                    : '/api/stream?file=' + encodeURIComponent(m.path);
                ssImage.src = src;
                ssImage.style.display = '';
            } else {
                ssVideo.src = '/api/stream?file=' + encodeURIComponent(m.path);
                ssVideo.style.display = '';
                ssVideo.play().catch(() => {});
            }

            ssCounter.textContent = (ssIdx + 1) + ' / ' + allMedia.length;
            ssTitle.textContent = m.name;
            ssDownload.href = '/api/download?file=' + encodeURIComponent(m.path);

            // Auto-advance
            clearTimeout(ssTimer);
            cancelAnimationFrame(ssProgressTimer);
            ssProgress.style.width = '0%';

            if (ssPlaying) {
                if (isPhoto) {
                    startAutoAdvance();
                } else {
                    // For video: advance when it ends
                    ssVideo.onended = () => showSlide(ssIdx + 1);
                }
            }
        }

        function startAutoAdvance() {
            const dur = getInterval();
            const start = performance.now();
            ssProgress.style.transition = 'none';
            ssProgress.style.width = '0%';

            function tick() {
                const elapsed = performance.now() - start;
                const pct = Math.min(100, (elapsed / dur) * 100);
                ssProgress.style.width = pct + '%';
                if (elapsed >= dur) {
                    showSlide(ssIdx + 1);
                } else {
                    ssProgressTimer = requestAnimationFrame(tick);
                }
            }
            ssProgressTimer = requestAnimationFrame(tick);
        }

        // Controls
        document.getElementById('ssPrev').addEventListener('click', () => showSlide(ssIdx - 1));
        document.getElementById('ssNext').addEventListener('click', () => showSlide(ssIdx + 1));
        document.getElementById('ssNavLeft').addEventListener('click', () => showSlide(ssIdx - 1));
        document.getElementById('ssNavRight').addEventListener('click', () => showSlide(ssIdx + 1));
        document.getElementById('ssPlayPause').addEventListener('click', () => {
            ssPlaying = !ssPlaying;
            ssPlayIcon.className = ssPlaying ? 'bi bi-pause-fill' : 'bi bi-play-fill';
            if (ssPlaying) showSlide(ssIdx); // restart timer
            else { clearTimeout(ssTimer); cancelAnimationFrame(ssProgressTimer); }
        });
        document.getElementById('ssClose').addEventListener('click', () => {
            overlay.style.display = 'none';
            ssVideo.pause(); ssVideo.removeAttribute('src');
            clearTimeout(ssTimer); cancelAnimationFrame(ssProgressTimer);
            document.body.style.overflow = '';
        });
        ssSpeed.addEventListener('change', () => { if (ssPlaying) showSlide(ssIdx); });

        // Keyboard
        document.addEventListener('keydown', (e) => {
            if (overlay.style.display === 'none') return;
            if (e.key === 'Escape') document.getElementById('ssClose').click();
            if (e.key === 'ArrowRight') showSlide(ssIdx + 1);
            if (e.key === 'ArrowLeft') showSlide(ssIdx - 1);
            if (e.key === ' ') { e.preventDefault(); document.getElementById('ssPlayPause').click(); }
        });

        // Start slideshow
        document.getElementById('btnSlideshow').addEventListener('click', () => {
            ssIdx = 0; ssPlaying = true;
            ssPlayIcon.className = 'bi bi-pause-fill';
            overlay.style.display = '';
            document.body.style.overflow = 'hidden';
            showSlide(0);
        });
    })();
        </text>
    }
</script>
}
